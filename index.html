<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario ‚úÖ</title>
    <style>
        :root { --p-violet: #b35bd6; --bg-glass: rgba(30, 30, 30, 0.9); --p-light: #e0b3ff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000 url('Dise%C3%B1o%20sin%20t%C3%ADtulo%20(12).png') no-repeat center center fixed; background-size: cover; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; min-height: 100vh; }
        h1 { color: #ffffff; letter-spacing: 2px; text-transform: uppercase; margin-top: 20px; text-shadow: 2px 2px 10px var(--p-violet); font-size: 1.5rem; }
        .user-box { margin-bottom: 20px; font-weight: bold; color: #fff; background: rgba(40, 40, 40, 0.8); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 10px; }
        select { padding: 8px; border-radius: 8px; border: 2px solid white; font-weight: bold; cursor: pointer; outline: none; }
        .inventory-card { background: var(--bg-glass); color: white; padding: 15px; border-radius: 20px; width: 95%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-bottom: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); display: none; }
        .section-title { text-align: center; color: var(--p-light); font-weight: bold; text-transform: uppercase; font-size: 0.8em; margin: 20px 0 10px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; letter-spacing: 1px; }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .prod-info { flex: 1; }
        .prod-name { font-size: 0.85em; font-weight: bold; text-transform: uppercase; }
        .mod-time { font-size: 0.7em; font-style: italic; opacity: 0.8; margin-top: 2px; }
        .qty-box { min-width: 40px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: bold; font-size: 0.85em; margin-right: 10px; }
        .input-group { display: flex; gap: 5px; }
        input[type="number"] { width: 45px; padding: 5px; border-radius: 6px; border: none; text-align: center; font-weight: bold; }
        .btn-save-all { color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 95%; max-width: 500px; margin-bottom: 30px; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; }
    </style>
</head>
<body onload="updateUserUI()">

    <div id="loading-overlay">Cargando datos üêªüå∏üíÄ..</div>

    <h1>Inventario</h1>

    <div class="user-box">
        USUARIO: 
        <select id="userSelect" onchange="updateUserUI();">
            <option value="GIULY" style="background-color: #b4849f; color: white;">GIULY</option>
            <option value="ALEX" style="background-color: #a7a7df; color: white;">ALEX</option>
            <option value="NASHIRA" style="background-color: #6e4792; color: white;">NASHIRA</option>
        </select>
    </div>

    <div class="inventory-card" id="mainCard">
        <div id="listContainer"></div>
        <div class="section-title">‚ú® Cortes Especiales y OTROS</div>
        <div id="extraContainer"></div>
    </div>

    <button id="btnSave" class="btn-save-all" onclick="saveAllChanges()">üíæ GUARDAR CAMBIOS</button>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwsO41veRFVbzPLycyBRC17lynjy_DzEwzyusDr2UWQvryFCn7ISwRg6HmIBLvkUqTHsA/exec'; 
        let inventoryData = [];
        const userColors = { "GIULY": "#b4849f", "ALEX": "#a7a7df", "NASHIRA": "#6e4792" };

        const emojis = {
            "carne de venado": "ü¶å", "losa de carne": "ü•©", "jamon": "üçñ", "bolonias": "ü•™",
            "aguas carbonatadas": "ü•§", "naranja": "üçä", "pi√±a": "üçç", "fresa": "üçì", "manzana": "üçé",
            "medallones de carne": "üçî", "jam√≥n rebanado": "üçñ", "lomo de ternera": "ü•©", 
            "solomillo de res": "ü•©", "masa": "üçú", "jugo de manzana": "üçé", 
            "jugo de pi√±a": "üçç", "jugo de fresa": "üçì", "jugo de naranja": "üçä"
        };

        const extraItems = ["medallones de carne", "jam√≥n rebanado", "lomo de ternera", "solomillo de res", "masa", "jugo de fresa", "jugo de naranja", "jugo de pi√±a", "jugo de manzana"];

        function timeSince(dateString) {
            // Si es un guion o est√° vac√≠o, no mostrar tiempo
            if (!dateString || dateString === "-" || dateString === "" || dateString === "undefined") return "Sin movimientos";
            
            try {
                // Limpiar la fecha (quitar comas o caracteres raros)
                const parts = String(dateString).match(/\d+/g);
                if (!parts || parts.length < 3) return "Sin movimientos";

                // p[0]=d√≠a, p[1]=mes, p[2]=a√±o, p[3]=hora, p[4]=min
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                let year = parseInt(parts[2]);
                if (year < 100) year += 2000;

                const lastUpdate = new Date(year, month, day, parts[3]||0, parts[4]||0, parts[5]||0);
                const diffSec = Math.floor((new Date() - lastUpdate) / 1000);

                if (isNaN(diffSec) || diffSec > 10000000) return "Sin movimientos";
                if (diffSec < 10) return "Reci√©n ahora";
                if (diffSec < 60) return `Hace ${diffSec} seg`;
                
                const diffMin = Math.floor(diffSec / 60);
                if (diffMin < 60) return `Hace ${diffMin} min`;
                
                const diffHrs = Math.floor(diffMin / 60);
                if (diffHrs < 24) return `Hace ${diffHrs} h`;
                
                return `Hace ${Math.floor(diffHrs/24)} d`;
            } catch (e) { return "Sin movimientos"; }
        }

        function updateUserUI() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            document.getElementById('userSelect').style.backgroundColor = color;
            document.getElementById('btnSave').style.backgroundColor = color;
            renderInventory();
        }

        async function loadFromSheet() {
            try {
                const response = await fetch(WEB_APP_URL);
                inventoryData = await response.json();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('mainCard').style.display = 'block';
                renderInventory();
            } catch (e) { document.getElementById('loading-overlay').innerText = "‚ö†Ô∏è Error de conexi√≥n"; }
        }

        function renderInventory() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            const container = document.getElementById('listContainer');
            const extraContainer = document.getElementById('extraContainer');
            
            container.innerHTML = '';
            extraContainer.innerHTML = '';
            
            const colIdx = (user === "GIULY") ? 1 : (user === "ALEX") ? 3 : 5;
            const dateIdx = colIdx + 1;
            
            inventoryData.forEach((row, i) => {
                const name = row[0] ? row[0].toString().trim() : "";
                // ELIMINAR NOTAS: Si el nombre tiene "nota", no lo dibujamos
                if (i < 2 || !name || name.toLowerCase().includes("nota") || name.toLowerCase() === "producto") return;
                
                const isExtra = extraItems.includes(name.toLowerCase());
                const html = `
                    <div class="row">
                        <div class="prod-info">
                            <div class="prod-name">${emojis[name.toLowerCase()] || "üì¶"} ${name}</div>
                            <div class="mod-time" style="color:${color}" data-date="${row[dateIdx]}">Modificado: ${timeSince(row[dateIdx])}</div>
                        </div>
                        <div class="qty-box" style="background-color:${color}">${row[colIdx] || 0}</div>
                        <div class="input-group">
                            <input type="number" class="qty-input" data-prod="${name}" data-col="${colIdx}" placeholder="0">
                        </div>
                    </div>`;
                
                if (isExtra) extraContainer.innerHTML += html;
                else container.innerHTML += html;
            });
        }

        // Actualizar los minutos autom√°ticamente cada 10 segundos
        setInterval(() => {
            document.querySelectorAll('.mod-time').forEach(el => {
                const date = el.getAttribute('data-date');
                el.innerText = "Modificado: " + timeSince(date);
            });
        }, 10000);

        async function saveAllChanges() {
            const inputs = document.querySelectorAll('.qty-input');
            let updates = [];
            const userCol = parseInt(inputs[0].getAttribute('data-col'));

            inputs.forEach(input => {
                let val = parseInt(input.value);
                if (!isNaN(val) && val !== 0) {
                    updates.push({ producto: input.getAttribute('data-prod'), cantidad: val, userCol: userCol });
                }
            });

            if (updates.length === 0) return alert("No hay cambios.");
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').innerText = "Guardando...";
            
            for (let up of updates) { 
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(up) }); 
            }
            location.reload();
        }

        loadFromSheet();
    </script>
</body>
</html>
